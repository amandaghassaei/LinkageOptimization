/**
 * Created by aghassaei on 1/7/15.
 */

//setup persistent global variables
if (typeof globals === "undefined") globals = {};


$(function(){

    //init web workers
//    window.workers = persistentWorkers(8);

    if (window.location.href == "http://amandaghassaei.github.io/LinkageOptimization/"){
        $(window).bind('beforeunload', function(){
          return 'Are you sure you want to leave?';
        });
    }

    globals.saveFile = function(data, name, extension){
        var blob = new Blob([data], {type: "text/plain;charset=utf-8"});
        saveAs(blob, name + extension);
    };

    globals.setTargetCurve = function(curve){
        // var cumulativeX = 0;
        // var cumulativeY = 0;
        // _.each(curve, function(point){
        //     cumulativeX += point.x;
        //     cumulativeY += point.y;
        // });
        // var centerX = cumulativeX/curve.length;
        // var centerY = cumulativeY/curve.length;
        // _.each(curve, function(point){
        //     point.x -= centerX;
        //     point.y -= centerY;
        // });
        
        var params = Linkage.prototype.getTranslationScaleRotation(curve);
        // console.log('params', params);
        globals.targetCurve = Linkage.prototype.normalizeTrajectory(curve, params);
        globals.appState.set("numPositionSteps", globals.targetCurve.length);
        // console.log('curve', globals.targetCurve);
        // globals.targetCurve = curve;
    };

    //init global singletons
    globals.runStatistics = [];
    globals.three = new ThreeModel();
    globals.svg = new ThreeSVG();
    globals.physics = new PhysicsModel();
    globals.appState = new AppState();
    globals.setTargetCurve(
        [{"x":3.170206032277887,"y":5.0848127563348005},{"x":2.960008356812785,"y":7.755227192829276},{"x":2.5369324447224506,"y":10.420312789543974},{"x":1.9034080605102879,"y":13.333802853169232},{"x":0.8104723776607214,"y":16.1352939144047},{"x":-1.021884624742315,"y":17.944016973972108},{"x":-3.4379611643719814,"y":18.33423996559053},{"x":-5.923247920766317,"y":17.758007773452},{"x":-8.175487670819306,"y":17.14555918265133},{"x":-10.119035428179908,"y":17.062120480126072},{"x":-11.591222096970128,"y":17.54580924390304},{"x":-12.403635996497156,"y":18.360879338355428},{"x":-12.498903326435428,"y":19.322089981835337},{"x":-12.093399156909182,"y":20.44270427637573},{"x":-11.635054291343899,"y":21.73154298183309},{"x":-11.481249479370256,"y":23.159009792827792},{"x":-12.010343048721158,"y":24.400615458415338},{"x":-13.66947098404489,"y":24.51850816756527},{"x":-16.19009196442678,"y":23.234573483250735},{"x":-19.011639150589655,"y":20.861785947373093},{"x":-21.751471854269823,"y":17.825805468677043},{"x":-24.18381422325493,"y":14.535249823701445},{"x":-26.187527336434556,"y":11.288802933497696},{"x":-27.72519317737267,"y":8.197709097281663},{"x":-28.80607556099788,"y":5.198376584565},{"x":-29.440230409672807,"y":2.1452252600518786},{"x":-29.609597059725616,"y":-1.0922294927269351},{"x":-29.257209417076588,"y":-4.569416432906104},{"x":-28.29782060071039,"y":-8.23433389120506},{"x":-26.66805147040114,"y":-11.916390648018549},{"x":-24.405793565483265,"y":-15.36341917052216},{"x":-21.69224480972812,"y":-18.336347380483396},{"x":-18.800876779506087,"y":-20.700755876397224},{"x":-15.98777941763848,"y":-22.447695100338517},{"x":-13.406194008004789,"y":-23.65180627997265},{"x":-11.087379314367737,"y":-24.417837529519044},{"x":-8.972930218007985,"y":-24.8459547982951},{"x":-6.964337704284181,"y":-25.01826542056491},{"x":-4.962219600141397,"y":-24.999996282017868},{"x":-2.8779982155394292,"y":-24.851097711382845},{"x":-0.6029212689905661,"y":-24.649475492176943},{"x":2.07550769595108,"y":-24.514743781229228},{"x":5.343855921403538,"y":-24.445082858940655},{"x":8.334040088107255,"y":-23.702859446621478},{"x":9.994628692099578,"y":-21.59889088206955},{"x":9.625458482923882,"y":-17.699061533046404},{"x":7.220477455733928,"y":-12.615964676223347},{"x":4.788457162763314,"y":-7.433228786544974},{"x":3.570948612014078,"y":-2.3871188988841063},{"x":3.2303153109565135,"y":1.9486909391114784}]
        // [{"x":-5.117309897530315,"y":38.32711477748931},{"x":-2.5985331618740974,"y":39.4059660955054},{"x":0.010781423609685009,"y":40.35069724679184},{"x":2.608726481663376,"y":41.13183667124075},{"x":5.02910474553677,"y":41.6825724316769},{"x":7.050434639135362,"y":41.99144935049261},{"x":8.458260462841816,"y":42.11272663973869},{"x":9.117505652860057,"y":42.16649874867241},{"x":9.010498015962812,"y":42.28704365692919},{"x":8.208387380175102,"y":42.5530608574297},{"x":6.827527168432659,"y":42.95061803241977},{"x":5.011670907813091,"y":43.386714726591535},{"x":2.926208147629733,"y":43.736603997423416},{"x":0.7392208254194652,"y":43.89592094990653},{"x":-1.40074689356929,"y":43.81063486116941},{"x":-3.398164796407791,"y":43.48756777097381},{"x":-5.198367107167615,"y":42.98882559190768},{"x":-6.793887611720229,"y":42.37966741118078},{"x":-8.209464118581131,"y":41.71743970950435},{"x":-9.486695393739035,"y":41.03461071178208},{"x":-10.67426487325882,"y":40.336495373360314},{"x":-11.816292041118256,"y":39.6125645335109},{"x":-12.950958070059185,"y":38.85217220637908},{"x":-14.07736706320837,"y":38.03654393534095},{"x":-15.201603004543054,"y":37.17131018890068},{"x":-16.309901539440943,"y":36.26426129214647},{"x":-17.36767731760639,"y":35.326352761545486},{"x":-18.354553553410167,"y":34.384773547514236},{"x":-19.242312474058465,"y":33.46381735159702},{"x":-20.010924021158623,"y":32.58900946101975},{"x":-20.64864291268287,"y":31.78117033284318},{"x":-21.152220884900455,"y":31.056442076056484},{"x":-21.52809311621559,"y":30.41827560430748},{"x":-21.77745341116695,"y":29.8828241822961},{"x":-21.915662567080673,"y":29.432094783227093},{"x":-21.943547029437084,"y":29.084772164357837},{"x":-21.86446018545663,"y":28.83985363033756},{"x":-21.67590127366643,"y":28.70369676108183},{"x":-21.366150784798688,"y":28.7041001574426},{"x":-20.927905272074295,"y":28.839953202980567},{"x":-20.350913696622253,"y":29.11798354694565},{"x":-19.62528616638187,"y":29.54222269009559},{"x":-18.742220383097283,"y":30.11183436212538},{"x":-17.69318321411022,"y":30.821965214455684},{"x":-16.469480657963704,"y":31.663526419320142},{"x":-15.06244387880478,"y":32.62258328464157},{"x":-13.46308826548173,"y":33.66041265330758},{"x":-11.669565654381119,"y":34.79932197372232},{"x":-9.6728426585985,"y":35.98470061931007},{"x":-7.481047074410466,"y":37.173575688524956}]
        // {x:8, y:6},
        // {x:7, y:0},
        // {x:3, y:-4},
        // {x:0, y:-6},
        // {x:-8, y:-6},
        // {x:-7, y:0},
        // {x:-3, y:-4},
        // {x:0, y:6}
        // {x:10.0,y:0.0},{x:7.071,y:7.071},
        // {x:0.0,y:10.0},{x:-7.071,y:7.071},
        // {x:-10.0,y:0.0},{x:-7.071,y:-7.071},
        // {x:0.0,y:-10.0},{x:7.071,y:-7.071}
    );
    globals.population = new Population();
    globals.population.init();

    //ui
    new MenuWrapper({model: globals.appState});
    globals.error = new MenuErrorView();
    new NavBar({model:globals.appState});
    new HelpModalView();


    //the lack of indenting is on purpose - looks weird in the script editor otherwise
globals.script = function(){
    //nothing here for now
};
    new ScriptMenuView({model:globals.appState});

//    globals.script();

    //threeJS View
    new ThreeView({model:globals.three, el: "#threeContainer"});
    new ThreeView({model:globals.svg, el: "#svgContainer"});

});
