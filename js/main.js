/**
 * Created by aghassaei on 1/7/15.
 */

//setup persistent global variables
if (typeof globals === "undefined") globals = {};


$(function(){

    //init web workers
//    window.workers = persistentWorkers(8);

    if (window.location.href == "http://amandaghassaei.github.io/LinkageOptimization/"){
        $(window).bind('beforeunload', function(){
          return 'Are you sure you want to leave?';
        });
    }

    globals.saveFile = function(data, name, extension){
        var blob = new Blob([data], {type: "text/plain;charset=utf-8"});
        saveAs(blob, name + extension);
    };

    globals.setTargetCurve = function(curve){
        // var cumulativeX = 0;
        // var cumulativeY = 0;
        // _.each(curve, function(point){
        //     cumulativeX += point.x;
        //     cumulativeY += point.y;
        // });
        // var centerX = cumulativeX/curve.length;
        // var centerY = cumulativeY/curve.length;
        // _.each(curve, function(point){
        //     point.x -= centerX;
        //     point.y -= centerY;
        // });
        
        var params = Linkage.prototype.getTranslationScaleRotation(curve);
        // console.log('params', params);
        globals.targetCurve = Linkage.prototype.normalizeTrajectory(curve, params);
        globals.appState.set("numPositionSteps", globals.targetCurve.length);
        // console.log('curve', globals.targetCurve);
        // globals.targetCurve = curve;
    };

    //init global singletons
    globals.runStatistics = [];
    globals.three = new ThreeModel();
    globals.svg = new ThreeSVG();
    globals.physics = new PhysicsModel();
    globals.appState = new AppState();
    globals.setTargetCurve(
        // top loopy
        [{"x":1.9388870786968884,"y":26.07896839848064},{"x":3.9252368211172506,"y":27.828086534404697},{"x":6.007946769521465,"y":29.680232607268483},{"x":8.160559818909803,"y":31.45163610678846},{"x":10.291830483889303,"y":32.802146934731525},{"x":12.259776988230197,"y":33.41566318024373},{"x":13.95622906679561,"y":33.20179929296692},{"x":15.37602456189772,"y":32.31152842060984},{"x":16.546549544149805,"y":30.962995049349267},{"x":17.530550130200435,"y":29.43201086465413},{"x":18.2800804845793,"y":27.899023817079026},{"x":18.73180379719659,"y":26.544597968807768},{"x":18.802880226633672,"y":25.513996190093476},{"x":18.44975471055771,"y":24.941291420825255},{"x":17.664669625094064,"y":24.92717886574047},{"x":16.45133411704314,"y":25.507823080530134},{"x":14.81075811776973,"y":26.624447812645116},{"x":12.757452299178995,"y":28.11118407676378},{"x":10.35675250754966,"y":29.720212477565653},{"x":7.750958438779284,"y":31.18507838140412},{"x":5.1473724907176805,"y":32.294515578953},{"x":2.767127460782247,"y":32.93936562462129},{"x":0.8004525312418904,"y":33.11814025221266},{"x":-0.6467425627358536,"y":32.90019344406306},{"x":-1.5575474949326578,"y":32.37756276196097},{"x":-1.9943954225490736,"y":31.619743011811945},{"x":-2.086143109171016,"y":30.62087608983765},{"x":-2.032120208131599,"y":29.223855041479645},{"x":-2.1125210463596895,"y":27.08355402737973},{"x":-2.6218565707349315,"y":23.96434526016499},{"x":-3.8265636902024682,"y":20.420563527958116},{"x":-5.96763042908945,"y":17.59781696233878},{"x":-9.062412278779234,"y":16.16082430016878},{"x":-12.623633746731235,"y":15.76870331265955},{"x":-15.82403378575484,"y":15.673461268362008},{"x":-18.012523126203444,"y":15.411568336888639},{"x":-18.978885206763604,"y":14.926753644613568},{"x":-18.877205847440777,"y":14.390903032853776},{"x":-18.02252226533743,"y":14.027038434667718},{"x":-16.72016269100473,"y":13.999087744348113},{"x":-15.182296766562663,"y":14.360817059205598},{"x":-13.524027925167196,"y":15.062193073202078},{"x":-11.79993741642632,"y":15.997552549156463},{"x":-10.040173540158271,"y":17.061990975141573},{"x":-8.267011792550084,"y":18.187364792946457},{"x":-6.495098142024528,"y":19.34989886252029},{"x":-4.726516330283033,"y":20.558210506898188},{"x":-2.9488397078269553,"y":21.834312657781187},{"x":-1.1401449269296595,"y":23.19207967713561},{"x":0.7231336678428749,"y":24.64596238955717}]
        // top small
        // [{"x":-4.466360365367026,"y":39.574926426537694},{"x":-5.231612424190993,"y":39.86513134757312},{"x":-6.2761000574586925,"y":40.165044484980626},{"x":-7.511744962204879,"y":40.44509430100934},{"x":-8.848247427430607,"y":40.661742158202934},{"x":-10.207209248634838,"y":40.77330346415056},{"x":-11.532212270620493,"y":40.754021742220175},{"x":-12.790875524621049,"y":40.59991014150881},{"x":-13.965047685455305,"y":40.33197479775945},{"x":-15.046905746218542,"y":39.98003208059914},{"x":-16.040499260344433,"y":39.57312064072014},{"x":-16.96035104565154,"y":39.12493369903424},{"x":-17.829946671703052,"y":38.639014030773794},{"x":-18.663717939439362,"y":38.112959875756985},{"x":-19.467028622506067,"y":37.55344224871631},{"x":-20.239908805576693,"y":36.96416888526145},{"x":-20.97572263044714,"y":36.34435821346132},{"x":-21.6716049620766,"y":35.6964540924531},{"x":-22.32187302389157,"y":35.02512349262867},{"x":-22.91732569214722,"y":34.33826564040604},{"x":-23.44966918748336,"y":33.650131527291904},{"x":-23.907950990579195,"y":32.97378134052387},{"x":-24.27896715771557,"y":32.32786148007263},{"x":-24.550928641323996,"y":31.73047469046687},{"x":-24.715029266855996,"y":31.197834566050467},{"x":-24.764139858675982,"y":30.747734566252287},{"x":-24.70201132570369,"y":30.378098879281005},{"x":-24.532629034592475,"y":30.08951381471605},{"x":-24.261325721291836,"y":29.88272835480936},{"x":-23.89311436448801,"y":29.758450267860514},{"x":-23.432640213287733,"y":29.736348815695994},{"x":-22.877087046376374,"y":29.795370797632767},{"x":-22.225019054524303,"y":29.94099997902326},{"x":-21.476235018350003,"y":30.175840899731508},{"x":-20.631132062559775,"y":30.49697460343376},{"x":-19.690435376019735,"y":30.899604538789045},{"x":-18.655532544064247,"y":31.377851485282644},{"x":-17.528148456064816,"y":31.9142049873787},{"x":-16.31238536110661,"y":32.53051734502846},{"x":-15.008880439148811,"y":33.195744463799876},{"x":-13.627794531024362,"y":33.90500406483297},{"x":-12.182960995333728,"y":34.653964829504616},{"x":-10.691909202170427,"y":35.42057909805056},{"x":-9.195346343681505,"y":36.18898378053785},{"x":-7.71867396926592,"y":36.91917420577442},{"x":-6.393714960979245,"y":37.59836236499165},{"x":-5.271417632756892,"y":38.17994514029836},{"x":-4.471312681970066,"y":38.64335989121642},{"x":-4.062069283899357,"y":39.00369856030893},{"x":-4.0725504523310585,"y":39.29891343933204}]
        // top loopy
        // [{"x":24.207556949032195,"y":25.306338056335992},{"x":29.285184067613827,"y":25.33706453255424},{"x":31.97741335627323,"y":24.590700753718778},{"x":32.628354425639,"y":23.59650254106712},{"x":32.21133783042076,"y":22.401835083796637},{"x":31.599458241237503,"y":20.726648592528885},{"x":31.14882209148161,"y":18.330602904831206},{"x":30.578037026975714,"y":15.207305849753219},{"x":29.304268404714833,"y":12.022046037981223},{"x":27.323022984873095,"y":9.943512136420734},{"x":25.35481314485706,"y":9.841292044674592},{"x":23.83105246150003,"y":11.942139802593921},{"x":22.413013578422568,"y":15.801864322371184},{"x":20.521555534249405,"y":20.543828719459224},{"x":17.8376194464138,"y":25.508421629398367},{"x":14.321486809862542,"y":30.33251029415291},{"x":10.248142041638665,"y":34.48722856945149},{"x":6.214751388578892,"y":37.386622110646414},{"x":2.8564454746492154,"y":38.76525525072499},{"x":0.532169927406346,"y":38.72053453894578},{"x":-0.7709830210949928,"y":37.56844486239938},{"x":-1.330972040976719,"y":35.72541610173724},{"x":-1.5305512919882993,"y":33.62986136676301},{"x":-1.7498261437311577,"y":31.65827514974682},{"x":-2.3253421835225994,"y":30.033506747751172},{"x":-3.467321114051577,"y":28.828540106959924},{"x":-5.310432341357577,"y":27.850338565814155},{"x":-7.7993501379948125,"y":26.814057007318695},{"x":-10.668979993700717,"y":25.426843281775845},{"x":-13.447573824704545,"y":23.64596104300696},{"x":-15.612225195985978,"y":21.8253225381618},{"x":-16.849055939983206,"y":20.447837687700954},{"x":-17.14579608050633,"y":19.70342389289836},{"x":-16.704125828833156,"y":19.389418860389657},{"x":-15.814502922659717,"y":19.171450942570246},{"x":-14.745996033294729,"y":18.84816204122283},{"x":-13.67514952117179,"y":18.418133761123002},{"x":-12.67317112769304,"y":17.997781524265843},{"x":-11.737054743563261,"y":17.708755578269905},{"x":-10.830542452693217,"y":17.61211423730105},{"x":-9.903540507387765,"y":17.699892279424695},{"x":-8.906208618777367,"y":17.93794020238429},{"x":-7.728386669415966,"y":18.270508748133732},{"x":-6.191165561035241,"y":18.661523030547777},{"x":-3.9931737336646993,"y":19.080871009005286},{"x":-0.7439426404370179,"y":19.566803020427916},{"x":3.7773674799856667,"y":20.317916464118316},{"x":9.375842920462373,"y":21.533641891789276},{"x":15.53936421576033,"y":23.05018173802434},{"x":21.55066724948204,"y":24.303555308677222}]
        // topflat 
        // [{"x":-1.1265027772526015,"y":9.128817315106392},{"x":-0.6594338020889305,"y":10.755699045457089},{"x":-0.4588053348178294,"y":12.252058243084532},{"x":-0.6297418898510851,"y":13.55783334912291},{"x":-1.2381650783874414,"y":14.621853904547853},{"x":-2.2916397039392686,"y":15.42849755536078},{"x":-3.744309680638948,"y":16.0195655488136},{"x":-5.51202605547665,"y":16.479216506979085},{"x":-7.496842657638428,"y":16.889431048786218},{"x":-9.612676047137978,"y":17.279563558181884},{"x":-11.780605845312227,"y":17.615556347871184},{"x":-13.930953618221254,"y":17.812406193641266},{"x":-15.999219441346328,"y":17.775978019858623},{"x":-17.934305810389862,"y":17.43861045120152},{"x":-19.707807089601758,"y":16.77721866381308},{"x":-21.314830859689216,"y":15.810791676110888},{"x":-22.765302884336943,"y":14.58577726311898},{"x":-24.072703462661888,"y":13.159762768664649},{"x":-25.24489947979547,"y":11.589123622676674},{"x":-26.27868255784553,"y":9.92197944216179},{"x":-27.158788342551276,"y":8.195974564660503},{"x":-27.861663701267762,"y":6.439838396714087},{"x":-28.36003256886671,"y":4.677787923934142},{"x":-28.63453488189558,"y":2.931400903224046},{"x":-28.67496562079346,"y":1.225031971492796},{"x":-28.48414576678377,"y":-0.4159136876001972},{"x":-28.076846343510137,"y":-1.9670227428006992},{"x":-27.4751949750736,"y":-3.4063201450552714},{"x":-26.70448702652546,"y":-4.714990460570066},{"x":-25.78553353602132,"y":-5.87582141047419},{"x":-24.73823299423884,"y":-6.876369247702201},{"x":-23.579712664693293,"y":-7.705429747127441},{"x":-22.326093360781535,"y":-8.350528636946672},{"x":-20.993421214005767,"y":-8.802487295023436},{"x":-19.599589439687705,"y":-9.055170316775728},{"x":-18.16414718079124,"y":-9.104434808763724},{"x":-16.706321839334844,"y":-8.950531025397542},{"x":-15.244256784766572,"y":-8.595053057710372},{"x":-13.795182789860906,"y":-8.042179330941597},{"x":-12.375697691843138,"y":-7.293854966982204},{"x":-11.002015628413327,"y":-6.360528418398926},{"x":-9.68707114809411,"y":-5.25315148225816},{"x":-8.44068024853803,"y":-3.9866278633407277},{"x":-7.26866824893584,"y":-2.5804042185877036},{"x":-6.172733304097373,"y":-1.0572630580721127},{"x":-5.151126351276742,"y":0.5578316129565428},{"x":-4.200065440436317,"y":2.2391393993675064},{"x":-3.3159461900894893,"y":3.9617392025266724},{"x":-2.4987569040896718,"y":5.7023603403718015},{"x":-1.7579554739615357,"y":7.437661084238172}]
        // topcurve [{"x":-22.294684590829938,"y":9.10572745483403},{"x":-21.493377516755373,"y":12.045274776695988},{"x":-20.513403681936083,"y":15.37106177802976},{"x":-19.22655590984799,"y":19.06494911452492},{"x":-17.493060371344523,"y":23.083077100168616},{"x":-15.184781175586712,"y":27.335958660569815},{"x":-12.233262375632693,"y":31.63475510344601},{"x":-8.773991855356188,"y":35.58156191921504},{"x":-5.3953752079528385,"y":38.54633366983022},{"x":-3.004033386182397,"y":40.068594113573866},{"x":-2.135017814645766,"y":40.3182796632534},{"x":-2.771853332650331,"y":39.95095450463064},{"x":-4.679979510374402,"y":39.59418358000533},{"x":-7.600066322186575,"y":39.51419890902786},{"x":-11.212218394562298,"y":39.54865613906568},{"x":-15.100979411654869,"y":39.30729863834816},{"x":-18.860168883617767,"y":38.486887659874725},{"x":-22.154195756719695,"y":37.06672305687961},{"x":-24.810776078587384,"y":35.257963551650626},{"x":-26.840131577514065,"y":33.32705429195018},{"x":-28.378454469685426,"y":31.46851137535451},{"x":-29.60683575026433,"y":29.76441197820051},{"x":-30.685177105025584,"y":28.187427248740878},{"x":-31.707361125967356,"y":26.6421757601469},{"x":-32.71831359678457,"y":25.009284493167865},{"x":-33.709950234351496,"y":23.200330679847713},{"x":-34.65679919039646,"y":21.176847473231593},{"x":-35.503494026614156,"y":18.96408937308699},{"x":-36.190877428852794,"y":16.629113542203683},{"x":-36.67385234549851,"y":14.269113384839294},{"x":-36.92784729557106,"y":11.984108408785263},{"x":-36.95874441513528,"y":9.85930363916662},{"x":-36.79220660944973,"y":7.942820180489126},{"x":-36.46614451084371,"y":6.243295938709978},{"x":-36.009363115334914,"y":4.738377714080874},{"x":-35.440797245462,"y":3.395346931557945},{"x":-34.77243413611888,"y":2.1877240036857986},{"x":-34.01333061918629,"y":1.1044344115895914},{"x":-33.159076442521204,"y":0.1594323189804566},{"x":-32.226768868115904,"y":-0.6176837757415393},{"x":-31.235569980066078,"y":-1.1916974605185384},{"x":-30.209114023162464,"y":-1.5287547885662602},{"x":-29.172167687819158,"y":-1.6015082217930279},{"x":-28.147280993986904,"y":-1.3900346353230515},{"x":-27.15348622696711,"y":-0.8797166645057047},{"x":-26.206337691694657,"y":-0.05827266473113528},{"x":-25.31769149366189,"y":1.0864400371962146},{"x":-24.493338675051504,"y":2.5672048974959045},{"x":-23.72989085346413,"y":4.3973667980643425},{"x":-23.005937874410613,"y":6.589874715153836}]
        // loop [{"x":3.170206032277887,"y":5.0848127563348005},{"x":2.960008356812785,"y":7.755227192829276},{"x":2.5369324447224506,"y":10.420312789543974},{"x":1.9034080605102879,"y":13.333802853169232},{"x":0.8104723776607214,"y":16.1352939144047},{"x":-1.021884624742315,"y":17.944016973972108},{"x":-3.4379611643719814,"y":18.33423996559053},{"x":-5.923247920766317,"y":17.758007773452},{"x":-8.175487670819306,"y":17.14555918265133},{"x":-10.119035428179908,"y":17.062120480126072},{"x":-11.591222096970128,"y":17.54580924390304},{"x":-12.403635996497156,"y":18.360879338355428},{"x":-12.498903326435428,"y":19.322089981835337},{"x":-12.093399156909182,"y":20.44270427637573},{"x":-11.635054291343899,"y":21.73154298183309},{"x":-11.481249479370256,"y":23.159009792827792},{"x":-12.010343048721158,"y":24.400615458415338},{"x":-13.66947098404489,"y":24.51850816756527},{"x":-16.19009196442678,"y":23.234573483250735},{"x":-19.011639150589655,"y":20.861785947373093},{"x":-21.751471854269823,"y":17.825805468677043},{"x":-24.18381422325493,"y":14.535249823701445},{"x":-26.187527336434556,"y":11.288802933497696},{"x":-27.72519317737267,"y":8.197709097281663},{"x":-28.80607556099788,"y":5.198376584565},{"x":-29.440230409672807,"y":2.1452252600518786},{"x":-29.609597059725616,"y":-1.0922294927269351},{"x":-29.257209417076588,"y":-4.569416432906104},{"x":-28.29782060071039,"y":-8.23433389120506},{"x":-26.66805147040114,"y":-11.916390648018549},{"x":-24.405793565483265,"y":-15.36341917052216},{"x":-21.69224480972812,"y":-18.336347380483396},{"x":-18.800876779506087,"y":-20.700755876397224},{"x":-15.98777941763848,"y":-22.447695100338517},{"x":-13.406194008004789,"y":-23.65180627997265},{"x":-11.087379314367737,"y":-24.417837529519044},{"x":-8.972930218007985,"y":-24.8459547982951},{"x":-6.964337704284181,"y":-25.01826542056491},{"x":-4.962219600141397,"y":-24.999996282017868},{"x":-2.8779982155394292,"y":-24.851097711382845},{"x":-0.6029212689905661,"y":-24.649475492176943},{"x":2.07550769595108,"y":-24.514743781229228},{"x":5.343855921403538,"y":-24.445082858940655},{"x":8.334040088107255,"y":-23.702859446621478},{"x":9.994628692099578,"y":-21.59889088206955},{"x":9.625458482923882,"y":-17.699061533046404},{"x":7.220477455733928,"y":-12.615964676223347},{"x":4.788457162763314,"y":-7.433228786544974},{"x":3.570948612014078,"y":-2.3871188988841063},{"x":3.2303153109565135,"y":1.9486909391114784}]
        // original tester [{"x":-5.117309897530315,"y":38.32711477748931},{"x":-2.5985331618740974,"y":39.4059660955054},{"x":0.010781423609685009,"y":40.35069724679184},{"x":2.608726481663376,"y":41.13183667124075},{"x":5.02910474553677,"y":41.6825724316769},{"x":7.050434639135362,"y":41.99144935049261},{"x":8.458260462841816,"y":42.11272663973869},{"x":9.117505652860057,"y":42.16649874867241},{"x":9.010498015962812,"y":42.28704365692919},{"x":8.208387380175102,"y":42.5530608574297},{"x":6.827527168432659,"y":42.95061803241977},{"x":5.011670907813091,"y":43.386714726591535},{"x":2.926208147629733,"y":43.736603997423416},{"x":0.7392208254194652,"y":43.89592094990653},{"x":-1.40074689356929,"y":43.81063486116941},{"x":-3.398164796407791,"y":43.48756777097381},{"x":-5.198367107167615,"y":42.98882559190768},{"x":-6.793887611720229,"y":42.37966741118078},{"x":-8.209464118581131,"y":41.71743970950435},{"x":-9.486695393739035,"y":41.03461071178208},{"x":-10.67426487325882,"y":40.336495373360314},{"x":-11.816292041118256,"y":39.6125645335109},{"x":-12.950958070059185,"y":38.85217220637908},{"x":-14.07736706320837,"y":38.03654393534095},{"x":-15.201603004543054,"y":37.17131018890068},{"x":-16.309901539440943,"y":36.26426129214647},{"x":-17.36767731760639,"y":35.326352761545486},{"x":-18.354553553410167,"y":34.384773547514236},{"x":-19.242312474058465,"y":33.46381735159702},{"x":-20.010924021158623,"y":32.58900946101975},{"x":-20.64864291268287,"y":31.78117033284318},{"x":-21.152220884900455,"y":31.056442076056484},{"x":-21.52809311621559,"y":30.41827560430748},{"x":-21.77745341116695,"y":29.8828241822961},{"x":-21.915662567080673,"y":29.432094783227093},{"x":-21.943547029437084,"y":29.084772164357837},{"x":-21.86446018545663,"y":28.83985363033756},{"x":-21.67590127366643,"y":28.70369676108183},{"x":-21.366150784798688,"y":28.7041001574426},{"x":-20.927905272074295,"y":28.839953202980567},{"x":-20.350913696622253,"y":29.11798354694565},{"x":-19.62528616638187,"y":29.54222269009559},{"x":-18.742220383097283,"y":30.11183436212538},{"x":-17.69318321411022,"y":30.821965214455684},{"x":-16.469480657963704,"y":31.663526419320142},{"x":-15.06244387880478,"y":32.62258328464157},{"x":-13.46308826548173,"y":33.66041265330758},{"x":-11.669565654381119,"y":34.79932197372232},{"x":-9.6728426585985,"y":35.98470061931007},{"x":-7.481047074410466,"y":37.173575688524956}]
        // {x:8, y:6},
        // {x:7, y:0},
        // {x:3, y:-4},
        // {x:0, y:-6},
        // {x:-8, y:-6},
        // {x:-7, y:0},
        // {x:-3, y:-4},
        // {x:0, y:6}
        // {x:10.0,y:0.0},{x:7.071,y:7.071},
        // {x:0.0,y:10.0},{x:-7.071,y:7.071},
        // {x:-10.0,y:0.0},{x:-7.071,y:-7.071},
        // {x:0.0,y:-10.0},{x:7.071,y:-7.071}
    );
    globals.population = new Population();
    globals.population.init();

    //ui
    new MenuWrapper({model: globals.appState});
    globals.error = new MenuErrorView();
    new NavBar({model:globals.appState});
    new HelpModalView();


    //the lack of indenting is on purpose - looks weird in the script editor otherwise
globals.script = function(){
    //nothing here for now
};
    new ScriptMenuView({model:globals.appState});

//    globals.script();

    //threeJS View
    new ThreeView({model:globals.three, el: "#threeContainer"});
    new ThreeView({model:globals.svg, el: "#svgContainer"});

});
